name: VIDEO EDITING PART 1 - TRIGGER KAGGLE

on:
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * *'   # 12:00 AM IST (6:30 PM UTC previous day)
    - cron: '0 5 * * *'     # 10:30 AM IST (5:00 AM UTC)

jobs:
  update-counter:
    runs-on: ubuntu-latest
    outputs:
      video_number: ${{ steps.increment.outputs.video_number }}
    steps:
      # Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: DoctorAnimate/doctor.animate
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          sparse-checkout: |
            counter_video_editing.py
            counter_video_editing.txt
            video_end_tracker.txt
          fetch-depth: 1

      # Set up Python for counter scripts
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.9'

      # Increment video editing counter
      - name: Increment Counter
        id: increment
        run: |
          python3 counter_video_editing.py
          VIDEO_NUMBER=$(cat counter_video_editing.txt)
          echo "video_number=$VIDEO_NUMBER" >> $GITHUB_OUTPUT
          echo "Updated video editing counter to: $VIDEO_NUMBER"

      # Commit updated counter file
      - name: Commit Counter Update
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add counter_video_editing.txt
          git commit -m "Update video editing counter" || echo "No changes to commit"
          git pull --rebase origin main || echo "No changes to pull"
          git push || echo "No changes to push"

  run-on-kaggle:
    needs: update-counter
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: DoctorAnimate/doctor.animate
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          sparse-checkout: |
            IPNBY/watermark_quality.ipynb
            VIDEO_EDITING_WATERMARK
            counter_video_editing.txt
            video_end_tracker.txt
            requirements.txt
            requirementswatermark.txt
            kaggle_account_tracker.txt
          fetch-depth: 1

      # Pull latest changes (includes updated counter)
      - name: Pull Latest Changes
        run: |
          git pull origin main

      # Read current Kaggle account number
      - name: Read Kaggle Account Number
        id: read_kaggle_account
        run: |
          ACCOUNT_NUM=$(cat kaggle_account_tracker.txt)
          echo "account_number=$ACCOUNT_NUM" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Current Kaggle account number: $ACCOUNT_NUM"

      # Set Kaggle credentials based on account number
      - name: Set Kaggle Credentials
        id: set_kaggle_creds
        run: |
          ACCOUNT_NUM=${{ steps.read_kaggle_account.outputs.account_number }}
          
          # Dynamically get the username and key from secrets based on account number
          case $ACCOUNT_NUM in
            1)
              KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME_1 }}"
              KAGGLE_KEY="${{ secrets.KAGGLE_KEY_1 }}"
              ;;
            2)
              KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME_2 }}"
              KAGGLE_KEY="${{ secrets.KAGGLE_KEY_2 }}"
              ;;
            3)
              KAGGLE_USERNAME="${{ secrets.KAGGLE_USERNAME_3 }}"
              KAGGLE_KEY="${{ secrets.KAGGLE_KEY_3 }}"
              ;;
            *)
              echo "âŒ Invalid account number: $ACCOUNT_NUM"
              exit 1
              ;;
          esac
          
          echo "kaggle_username=$KAGGLE_USERNAME" >> $GITHUB_OUTPUT
          echo "kaggle_key=$KAGGLE_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Using Kaggle credentials for account $ACCOUNT_NUM"
          echo "ğŸ“ Kaggle Username: $KAGGLE_USERNAME"

      # Configure Sparse Checkout for specific video
      - name: Configure Sparse Checkout
        run: |
          VIDEO_NUMBER="${{ needs.update-counter.outputs.video_number }}"
          echo "Processing Video_${VIDEO_NUMBER}.mp4"
          echo "VIDEOS/Video_${VIDEO_NUMBER}.mp4" >> .git/info/sparse-checkout
          echo "REELS/test.mp4" >> .git/info/sparse-checkout
          git sparse-checkout reapply

      # Install Kaggle API
      - name: Install Kaggle API
        run: pip install kaggle

      # Configure Kaggle with credentials
      - name: Configure Kaggle
        run: |
          mkdir -p ~/.kaggle
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          KAGGLE_KEY="${{ steps.set_kaggle_creds.outputs.kaggle_key }}"
          echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          echo "ğŸ”§ Configured Kaggle credentials"
          echo "ğŸ“ Kaggle Username: $KAGGLE_USERNAME"

      # Prepare Dataset Folder
      - name: Prepare Dataset Folder
        run: |
          mkdir -p kaggle-dataset
          cp -r REELS kaggle-dataset/ || true
          cp -r VIDEO_EDITING_WATERMARK kaggle-dataset/ || true
          cp counter_video_editing.txt kaggle-dataset/ || true
          cp video_end_tracker.txt kaggle-dataset/ || true
          cp requirementswatermark.txt kaggle-dataset/ || true
          cp requirements.txt kaggle-dataset/ || true
          cp IPNBY/watermark_quality.ipynb kaggle-dataset/
          
          # Include the sparse-checked video file
          VIDEO_NUMBER="${{ needs.update-counter.outputs.video_number }}"
          mkdir -p kaggle-dataset/VIDEOS
          cp "VIDEOS/Video_${VIDEO_NUMBER}.mp4" kaggle-dataset/VIDEOS/ || echo "âš ï¸ Video file not found: VIDEOS/Video_${VIDEO_NUMBER}.mp4"

          # Kaggle dataset metadata
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          cat > kaggle-dataset/dataset-metadata.json <<EOF
          {
            "id": "$KAGGLE_USERNAME/video-editing-data",
            "title": "Video Editing Data",
            "licenses": [
              { "name": "CC0-1.0" }
            ],
            "isPrivate": true
          }
          EOF

      # Create or Update Kaggle Dataset
      - name: Create or Update Kaggle Dataset
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          for i in $(seq 1 5); do
            if kaggle datasets status $KAGGLE_USERNAME/video-editing-data >/dev/null 2>&1; then
              echo "âœ… Dataset exists, versioning... (Attempt $i)"
              if kaggle datasets version -p kaggle-dataset -m "Update dataset for run" --dir-mode zip; then
                echo "âœ… Versioning successful"
                break
              fi
            else
              echo "âš¡ Dataset not found, creating... (Attempt $i)"
              if kaggle datasets create -p kaggle-dataset --dir-mode zip; then
                echo "âœ… Creation successful"
                break
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "âš ï¸ Command failed. Retrying in 30 seconds..."
              sleep 30
            else
              echo "âŒ Command failed after 5 attempts."
              exit 1
            fi
          done

      # List datasets
      - name: List Datasets
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          echo "ğŸ“¦ Listing datasets for user: $KAGGLE_USERNAME"
          sleep 60
          kaggle datasets list --user $KAGGLE_USERNAME

      # Prepare Kernel Metadata
      - name: Prepare Kernel Metadata
        run: |
          KAGGLE_USERNAME="${{ steps.set_kaggle_creds.outputs.kaggle_username }}"
          cat > kernel-metadata.json <<EOF
          {
            "id": "$KAGGLE_USERNAME/video-editing-scheduler-notebook",
            "title": "Video Editing Scheduler Notebook",
            "code_file": "IPNBY/watermark_quality.ipynb",
            "language": "python",
            "kernel_type": "notebook",
            "is_private": true,
            "enable_gpu": true,
            "enable_internet": true,
            "dataset_sources": [
              "$KAGGLE_USERNAME/video-editing-data"
            ],
            "competition_sources": [],
            "kernel_sources": [],
            "model_sources": []
          }
          EOF

      # Push Notebook to Kaggle
      - name: Push Notebook to Kaggle
        run: |
          kaggle kernels push -p .
          echo "âœ… Notebook pushed to Kaggle successfully"
          echo "ğŸ“Œ Kaggle will process this in the background"
          echo "ğŸ•’ Part 2 workflow will download outputs in ~10 hours"
